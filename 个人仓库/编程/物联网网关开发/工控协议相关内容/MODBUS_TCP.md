# 一、协议简述(一些概念性问题)
1. 通讯架构：
	1. 通讯采用CS架构，由客户端发起请求服务端进行响应
	2. 一对多的通讯模式，采用单播模式。由特定服务器进行处理并反馈
2. 连接参数：
	1. IP
	2. 端口
	3. 传输协议(TCP、UDP)
# 二、读取报文解析
1、发送报文体解析(客户端)
0001 0000 0006 01 03 0001 0002
1. 00 01：事务ID，用于匹配相应于请求的标识
2. 00 00：协议标识，MODBUS协议固定为0x0000
3. 00 06：后续字节长度
4. 01：设备ID
5. 03：功能码
![[Pasted image 20250228160418.png]]
1. 00 01：起始地址
2. 00 02：读取2个16-bit(两个字),一个INT数据类型
2、返回报文体解析(服务端)
0001 0000 0007 01 03 04 ffff 0000
1. 00 01：事务ID，用于匹配相应于请求的标识
2. 00 00：协议标识，MODBUS协议固定为0x0000
3. 00 07：后续数据长度(7字节)
4. 01：站地址
5. 03：功能码
6. 04：后续数据长度(4个字节)
7. ffff 0000：返回的数据（65535）,这里涉及到高低位交换的问题。
补充：对于寄存器类型来说，HSLCOMMUNCTION最多可以获取120个寄存器，超过的部分会自动拆分成多条命令
# 三、写入报文解析
1、发送报文体解析(客户端)
0020 0000 000b 01 10 0001 0002 04 ffff 0000
1. 0020 事务标识符
2. 0000 协议标识
3. 000b 后续字节长度
4. 01 设备地址
5. 10 功能码
6. 0001 写入起始地址
7. 0002 写入寄存器数量
8. 04 写入字节数
9. ffff0000实际数值(65535)
2、返回报文体解析(服务端)
0002 0000 0006 01 10 0001 0002
1. 0002：事务标识
2. 0000：协议标识
3. 0006：后续字节长度
4. 01：设备地址
5. 10：功能码
6. 0001：起始地址
7. 0002：写入数量
# 四、连接/断开连接报文解析(TCP的三次握手建立连接、四次挥手断开连接)
1、建立连接
![[Pasted image 20250301124007.png]]
2、断开连接
![[Pasted image 20250301124356.png]]
1. **客户端 → 服务器**：发送 **FIN, ACK**，请求关闭连接（客户端不再发送数据）。
2. **服务器 → 客户端**：发送 **ACK**，确认客户端请求，表示它已准备好关闭连接。
3. **服务器 → 客户端**：发送 **FIN, ACK**，服务器也完成了数据传输，准备关闭连接。
4. **客户端 → 服务器**：发送 **ACK**，客户端确认服务器请求，连接关闭完成。

# 五、TCP与UDP的区别
在研究时发现TCP协议每一次数据请求都有4个过程
![[Pasted image 20250228191803.png]]
1. 客户端发请求PSH,ACK(59849 → 503)
2. 服务器确认请求确认ACK（503 → 59849)
3. 服务端回复PSH,ACK（503 → 59849）
4. 客户端确认回复确认ACK（59849 → 503）

对应的UDP就只有请求和回复没有中间确认的环节



# 六、数据类型与字节的关系(补充)
### **1. 数据类型及字节长度**

MODBUS TCP 支持多种数据类型，每种类型对应一定的字节数。下面是一些常见数据类型的说明：

|**数据类型**|**描述**|**字节数**|**说明**|
|---|---|---|---|
|**Coils（线圈）**|离散输出位（开关量）|1 字节|一个线圈使用 1 位，MODBUS 中是按字节存储和传输。|
|**Discrete Inputs（离散输入）**|离散输入位（开关量输入）|1 字节|一个离散输入也使用 1 位。|
|**Input Registers（输入寄存器）**|只读寄存器（通常为模拟量输入）|2 字节|每个寄存器 16 位（2 字节）。|
|**Holding Registers（保持寄存器）**|可读写寄存器（通常为模拟量输出）|2 字节|每个寄存器 16 位（2 字节）。|
|**INT（有符号整数）**|有符号 16 位整数（通常用于表示小范围整数）|2 字节|表示从 -32,768 到 +32,767 的整数。|
|**UINT（无符号整数）**|无符号 16 位整数|2 字节|表示从 0 到 65,535 的整数。|
|**LONG（有符号长整数）**|有符号 32 位整数|4 字节|表示从 -2,147,483,648 到 +2,147,483,647 的整数。|
|**ULONG（无符号长整数）**|无符号 32 位整数|4 字节|表示从 0 到 4,294,967,295 的整数。|
|**FLOAT（单精度浮点数）**|IEEE 754 单精度浮点数|4 字节|使用 4 字节表示的单精度浮点数。|
|**DOUBLE（双精度浮点数）**|IEEE 754 双精度浮点数|8 字节|使用 8 字节表示的双精度浮点数。|

---

### **2. 字节、字、双字与位之间的关系**

#### **位（Bit）**

- **1 位** 是存储数据的最小单位，可以表示 **0 或 1**，通常用于表示一个 **线圈**（Coil）或 **离散输入**（Discrete Input）。

#### **字节（Byte）**

- **1 字节 = 8 位**（8 bits），是计算机数据的基本存储单位。
- 在 MODBUS 中，大部分数据以字节为单位传输，例如线圈、离散输入。

#### **字（Word）**

- **1 字 = 2 字节 = 16 位**。在 MODBUS 中，**每个寄存器（如保持寄存器、输入寄存器）通常使用 16 位**。
- 一个 **字** 由 **两个字节**组成，因此，MODBUS 中的寄存器总是按 2 字节存储。

#### **双字（Double Word）**

- **1 双字 = 4 字节 = 32 位**。在 MODBUS 中，**长整数（LONG 或 ULONG）** 或 **32 位浮点数（FLOAT）** 通常使用双字来表示。

---

### **3. 字节划分与数据类型对应关系**

下面是一些常见数据类型和其字节划分：

#### **3.1 线圈（Coil）**

- **存储：** 每个线圈占用 1 位，但在报文传输时，线圈是按字节传输的，因此 **1 字节 = 8 位** 可以表示 **最多 8 个线圈**。
- **功能：** 用于表示开关量状态（例如继电器开关、按钮状态）。

#### **3.2 离散输入（Discrete Input）**

- **存储：** 每个离散输入占 1 位，类似于线圈。
- **功能：** 用于表示传感器输入状态（例如开关传感器的状态）。

#### **3.3 输入寄存器（Input Register）**

- **存储：** 每个寄存器占 2 字节（16 位）。
- **功能：** 用于存储只读数据，例如模拟传感器输入的数值。

#### **3.4 保持寄存器（Holding Register）**

- **存储：** 每个寄存器占 2 字节（16 位）。
- **功能：** 用于存储可读写的模拟量数据，例如输出控制。

#### **3.5 INT（有符号 16 位整数）**

- **存储：** 2 字节。
- **功能：** 用于存储有符号的 16 位整数，表示的范围是 **-32,768 到 +32,767**。

#### **3.6 UINT（无符号 16 位整数）**

- **存储：** 2 字节。
- **功能：** 用于存储无符号的 16 位整数，表示的范围是 **0 到 65,535**。

#### **3.7 LONG（有符号 32 位整数）**

- **存储：** 4 字节（32 位）。
- **功能：** 用于存储有符号的 32 位整数，表示的范围是 **-2,147,483,648 到 +2,147,483,647**。

#### **3.8 ULONG（无符号 32 位整数）**

- **存储：** 4 字节（32 位）。
- **功能：** 用于存储无符号的 32 位整数，表示的范围是 **0 到 4,294,967,295**。

#### **3.9 FLOAT（单精度浮点数）**

- **存储：** 4 字节（32 位）。
- **功能：** 用于表示浮动小数点数值，采用 IEEE 754 单精度浮点格式。

#### **3.10 DOUBLE（双精度浮点数）**

- **存储：** 8 字节（64 位）。
- **功能：** 用于表示更高精度的浮动小数点数值，采用 IEEE 754 双精度浮点格式。